
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>çŠ¶æ€æœºï¼ˆState Machineï¼‰ | lovely-lily&#39;s blog</title>
    <meta name="author" content="lovely-lily" />
    <meta name="description" content="äºé“å„åŠªåŠ› åƒé‡Œè‡ªåŒé£" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>åŠ è½½è¿‡æ…¢è¯·å¼€å¯ç¼“å­˜ æµè§ˆå™¨é»˜è®¤å¼€å¯</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>LOVELY-LILY&#39;S BLOG</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;LOVELY-LILY&#39;S BLOG</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>çŠ¶æ€æœºï¼ˆState Machineï¼‰</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2025/4/27
        </span>
        
        <span class="category">
            <a href="/categories/Software/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Software
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/FSM/" style="color: #00a596">
                    FSM
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/C/" style="color: #ffa2c4">
                    C
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="å¼•"><a href="#å¼•" class="headerlink" title="å¼•"></a>å¼•</h2><p>ç®€å•è¯´ï¼Œ<strong>çŠ¶æ€æœº</strong>å°±æ˜¯ä¸€ç§åœ¨ä¸åŒçŠ¶æ€ä¹‹é—´<strong>åˆ‡æ¢</strong>ï¼Œå¹¶æ ¹æ®<strong>å½“å‰çŠ¶æ€</strong>å’Œ<strong>è¾“å…¥</strong>å†³å®šè¡Œä¸ºçš„æ¨¡å‹ã€‚</p>
<p>å¯ä»¥ç†è§£æˆè¿™æ ·çš„ä¸€å¥—ä¸œè¥¿ï¼š(å‡è‹¥æˆ‘æ˜¯ä¸€å°CDæœº)</p>
<p>ä¸€ç»„çŠ¶æ€ï¼ˆæ¯”å¦‚ï¼šIdleã€Playingã€Pausedï¼‰</p>
<p>ä¸€ç»„äº‹ä»¶&#x2F;è¾“å…¥ï¼ˆæ¯”å¦‚ï¼šStart æŒ‰é’®æŒ‰ä¸‹ã€Pause æŒ‰é’®æŒ‰ä¸‹ï¼‰</p>
<p>ä¸€ç»„è½¬ç§»è§„åˆ™ï¼ˆæ¯”å¦‚ï¼šåœ¨ Idle çŠ¶æ€ä¸‹æŒ‰ Start -&gt; åˆ‡åˆ° Playingï¼‰</p>
<p>ä¸€äº›åŠ¨ä½œï¼ˆçŠ¶æ€å˜åŒ–æ—¶è¦åšä»€ä¹ˆï¼Œæ¯”å¦‚åˆå§‹åŒ–èµ„æºã€æ›´æ–°ç•Œé¢ï¼‰</p>
<table>
<thead>
<tr>
<th>å½“å‰çŠ¶æ€</th>
<th>è¾“å…¥äº‹ä»¶</th>
<th>ä¸‹ä¸€ä¸ªçŠ¶æ€</th>
<th>åŠ¨ä½œ</th>
</tr>
</thead>
<tbody><tr>
<td>Idle</td>
<td>ç‚¹å‡»æ’­æ”¾</td>
<td>Playing</td>
<td>å¼€å§‹æ’­æ”¾éŸ³ä¹</td>
</tr>
<tr>
<td>Playing</td>
<td>ç‚¹å‡»æš‚åœ</td>
<td>Paused</td>
<td>æš‚åœéŸ³ä¹</td>
</tr>
<tr>
<td>Paused</td>
<td>ç‚¹å‡»æ’­æ”¾</td>
<td>Playing</td>
<td>ç»§ç»­æ’­æ”¾</td>
</tr>
<tr>
<td>Playing</td>
<td>æ’­æ”¾ç»“æŸ</td>
<td>Idle</td>
<td>å›åˆ°åˆå§‹çŠ¶æ€</td>
</tr>
</tbody></table>
<p>çŠ¶æ€æœºçš„æ ¸å¿ƒå°±æ˜¯ï¼šâ€œ<strong>çŠ¶æ€ + è¾“å…¥ â†’ åŠ¨ä½œ &amp; æ–°çŠ¶æ€</strong>â€</p>
<h3 id="è¡¨é©±åŠ¨çŠ¶æ€æœº"><a href="#è¡¨é©±åŠ¨çŠ¶æ€æœº" class="headerlink" title="è¡¨é©±åŠ¨çŠ¶æ€æœº"></a>è¡¨é©±åŠ¨çŠ¶æ€æœº</h3><p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <strong>C</strong> ä¸­çš„æ•°ç»„æ¥å®ç°å¦‚æ­¤ä¸€ä¸ªçŠ¶æ€æœºçš„<strong>è½¬ç§»è¡¨</strong>ï¼š</p>
<pre><code class="language-c">typedef void (*pfState)(void);

typedef enum eEvent &#123;
    EVT_NO_EVENT,
    EVT_Start_PRESSED,
    EVT_Pause_PRESSED,
    EVT_END
&#125; eEvent;

typedef struct stStmRow &#123;
    pfState  pSrcState;
    eEvent        eEvt;
    pfState pDestState;
&#125; StmRow_t;

// å®šä¹‰çŠ¶æ€å‡½æ•°
void stateIdle(void);
void statePlaying(void);
void statePaused(void);

static eEvent      eCurrentEvent       = EVT_NO_EVENT;
static pfState     pfCurrentState      = stateIdle;

// çŠ¶æ€äº‹ä»¶è¡¨
StmRow_t  stm[]= &#123;
&#123;stateIdle     , EVT_Start_PRESSED , statePlaying &#125;,
&#123;statePlaying  , EVT_Pause_PRESSED , statePaused  &#125;,
&#123;statePaused   , EVT_Start_PRESSED , statePlaying &#125;,
&#123;statePlaying  , EVT_END           , stateIdle    &#125;
&#125;;
</code></pre>
<p>é€šè¿‡ <code>StateMachineHandler</code> æŸ¥è¯¢åˆ¤æ–­ <code>pfCurrentState</code> å’Œ <code>eCurrentEvent</code> ä¸ <code>stm</code> ä¸­çš„æ˜¯å¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™æ‰§è¡Œç›¸åº”çš„åŠ¨ä½œï¼Œå¹¶åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚å½“ç„¶éœ€è¦ä¸ºçŠ¶æ€æ·»åŠ è¿›å…¥å’Œç¦»å¼€çš„åŠ¨ä½œï¼š</p>
<pre><code class="language-c">static bool bIsStateFirstEntry  = false;
static bool bIsStateAboutToExit = false;

void stateIdle(void)
&#123;
    if(bIsStateFirstEntry) &#123;
        // å¤„ç†åˆæ¬¡è¿›å…¥ï¼Œè¿›è¡Œç›¸å…³åˆå§‹åŒ–
    &#125;

    // ...

    if(bIsStateAboutToExit) &#123;
        // å¤„ç†ç¦»å¼€çŠ¶æ€ï¼Œæ¯”å¦‚é‡Šæ”¾å†…å­˜ï¼Œå¤ä½å¯„å­˜å™¨ç­‰
    &#125;
&#125;

void StateMachineHandler()
&#123;
    int idx = 0;
    if(EVT_NO_EVENT != eCurrentEvent) &#123;
        for(;idx &lt; sizeof(stm)/sizeof(StmRow_t); idx++) &#123;
            if( (stm[idx].pSrcState == pfCurrentState) &amp;&amp;
                (stm[idx].eEvt      == eCurrentEvent)) &#123;
                eCurrentEvent  = EVT_NO_EVENT;
                bIsStateAboutToExit = true;
                pfCurrentState();
                // æ›´æ–°çŠ¶æ€
                pfCurrentState = stm[idx].pDestState;
                bIsStateFirstEntry = true;
            &#125;
        &#125;
    &#125;

    if(NULL != pfCurrentState) &#123;
        pfCurrentState();
        bIsStateFirstEntry = false;
    &#125;
&#125;
</code></pre>
<h3 id="äº‹ä»¶é©±åŠ¨çŠ¶æ€æœº"><a href="#äº‹ä»¶é©±åŠ¨çŠ¶æ€æœº" class="headerlink" title="äº‹ä»¶é©±åŠ¨çŠ¶æ€æœº"></a>äº‹ä»¶é©±åŠ¨çŠ¶æ€æœº</h3><p>éœ€è¦æåŠçš„æ˜¯ï¼Œä¸Šæ–‡è¡¨é©±åŠ¨çŠ¶æ€æœºçš„å®ç°è¾ƒç¹çï¼Œä¸€èˆ¬ä¸ä¼šåº”ç”¨åœ¨å¦‚æ­¤ç®€å•çš„çŠ¶æ€æœºä¸­ã€‚</p>
<ul>
<li>æœ€å¿«é€Ÿçš„å†™æ³•ï¼š</li>
</ul>
<pre><code class="language-c">void CD_Handler()
&#123;
    if(Start_pressed) &#123;
        // ğŸµ Playing
    &#125;
    if(Pause_pressed) &#123;
        // â¸ Paused
    &#125;
    if(Play_End) &#123;
        // ğŸ’¤ Idle
    &#125;
&#125;
</code></pre>
<p>è¿™æ ·çš„ä»£ç <strong>éšå¼</strong>çš„æè¿°äº†çŠ¶æ€æœºï¼Œè€Œä¸”å­˜åœ¨é€»è¾‘éšæ‚£ï¼ŒæŸ¥è¯¢æ•ˆç‡ä½ã€‚</p>
<ul>
<li>æ™®éçš„çš„ <code>switch-case</code> ç¤ºä¾‹ï¼š</li>
</ul>
<pre><code class="language-c">void CD_Switcher()
&#123;
    switch (fsm-&gt;current_state) &#123;
        case Idle:
            if (event == Start_pressed) &#123;
                playing_actions();
                fsm-&gt;current_state = Playing;
            &#125;
            break;
        case Playing:
            if (event == Pause_pressed) &#123;
                paused_actions();
                fsm-&gt;current_state = Paused;
            &#125; else if (event == Play_End) &#123;
                idle_actions();
                fsm-&gt;current_state = Idle;
            &#125;
            break;
        // å…¶ä»–çŠ¶æ€...
    &#125;
&#125;
</code></pre>
<p>è¿™æ ·çœ‹èµ·æ¥ä¼¼ä¹æ¸…æ™°ä¸€ç‚¹ï¼Œä½†æ˜¯ç›´æ¥æ‰”è¿›ä¸»å¾ªç¯ä¸­ä¼šå¯¼è‡´CPUä¸€ç›´åœ¨æŸ¥è¯¢çŠ¶æ€æœºï¼Œä¸¥é‡é˜»å¡å…¶ä»–ä»»åŠ¡ã€‚å› æ­¤ï¼Œå¼•å…¥<strong>äº‹ä»¶é©±åŠ¨çŠ¶æ€æœº</strong>ï¼Œå½“æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå†è¿›è¡ŒçŠ¶æ€åˆ‡æ¢ï¼š</p>
<pre><code class="language-c">    eEvent event = dequeue(fsm-&gt;event_queue);
    if(event != No_event) &#123;
        CD_Switcher(fsm, event);
    &#125;
</code></pre>
<p>é€šè¿‡äº‹ä»¶é˜Ÿåˆ— <code>dequeue()</code> æ¥æ¨åŠ¨çŠ¶æ€æœºçš„æ›´æ–°ï¼Œä»è€Œé¿å…CPUçš„è½®è¯¢ã€‚åŒæ ·å¯ä»¥åœ¨è¡¨é©±åŠ¨çŠ¶æ€æœºä¸­å¼•å…¥äº‹ä»¶é˜Ÿåˆ—ã€‚</p>
<ul>
<li>é™¤äº† <code>if-if</code> è¿™ç§ä½æ•ˆå®ç°ï¼Œå…¶ä»–çš„çŠ¶æ€æœºå®ç°æŒ‰ç…§<strong>å¤–é¢è°ƒåº¦æ–¹å¼</strong>å†³å®šå®ƒæ˜¯ä¸æ˜¯<strong>é˜»å¡</strong>æˆ–è€…<strong>æ‰“ç©ºè½¬</strong>ã€‚</li>
</ul>
<h3 id="ä¸šåŠ¡ä¸å¼•æ“åˆ†ç¦»çŠ¶æ€æœº"><a href="#ä¸šåŠ¡ä¸å¼•æ“åˆ†ç¦»çŠ¶æ€æœº" class="headerlink" title="ä¸šåŠ¡ä¸å¼•æ“åˆ†ç¦»çŠ¶æ€æœº"></a>ä¸šåŠ¡ä¸å¼•æ“åˆ†ç¦»çŠ¶æ€æœº</h3><p>å›é¡¾æœ€åˆçš„è¡¨é©±åŠ¨çŠ¶æ€æœºå®ç°ï¼Œ<code>StateMachineHandler</code> åªè´Ÿè´£çŠ¶æ€åˆ‡æ¢ï¼Œè€Œä¸šåŠ¡é€»è¾‘åˆ™ç”±çŠ¶æ€å‡½æ•° <code>stateIdle</code> å®ç°ã€‚ä¸¤è€…è§£è€¦ï¼Œäº’ä¸æ±¡æŸ“ï¼Œäº’ä¸å¼ºä¾èµ–ã€‚</p>
<p>å°†å…·ä½“çš„ä¸šåŠ¡ä¸»ä½“ï¼ˆCDæœºï¼‰ä¸çŠ¶æ€æœºå¼•æ“åˆ†ç¦»ï¼ŒçŠ¶æ€æœºå¼•æ“åªè´Ÿè´£çŠ¶æ€åˆ‡æ¢ï¼Œä¸šåŠ¡ä¸»ä½“åˆ™è´Ÿè´£å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚è¿™æ ·ï¼ŒçŠ¶æ€æœºå¼•æ“å¯ä»¥å¤ç”¨ï¼Œè€Œä¸šåŠ¡ä¸»ä½“åˆ™å¯ä»¥ä¸“æ³¨äºè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>è¡¨é©±åŠ¨çš„æ˜¾è‘—ä¼˜ç‚¹æ˜¯ï¼š<strong>å¯è¯»æ€§å¼º</strong>ï¼ŒçŠ¶æ€è½¬ç§»è§„åˆ™æ˜ç¡®åœ°å†™åœ¨è½¬ç§»è¡¨ä¸­ã€‚<br>â€”â€”ä½†æ˜¯ï¼Œå½“çŠ¶æ€æœºéå¸¸å¤æ‚ã€åŠ¨æ€è½¬ç§»å¤šæ—¶ï¼Œè½¬ç§»è¡¨ä¹Ÿå¯èƒ½å˜å¾—éå¸¸åºå¤§ã€éš¾ä»¥ç»´æŠ¤ã€‚</p>
<p>æä¾›å®Œå…¨åˆ†ç¦»çš„ä¸šåŠ¡ä¸å¼•æ“ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/CuteMan0/fsm">ç®€å•çš„çŠ¶æ€æœºå¼•æ“å’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»çš„æ¡†æ¶</a></li>
</ul>
<p>ä½†è¿™å¹¶ä¸èƒ½ç›´æ¥è§£å†³çŠ¶æ€è½¬ç§»è¡¨è¿‡äºåºå¤§ã€éš¾ä»¥ç»´æŠ¤çš„é—®é¢˜ï¼Œä¸šåŠ¡é€»è¾‘ä¼šéšç€çŠ¶æ€çš„å¢åŠ è€Œè†¨èƒ€ã€‚éœ€è¦åœ¨æ­¤æ¶æ„ä¸­åˆ›å»ºå­çŠ¶æ€æœºï¼Œå°†çŠ¶æ€è½¬ç§»è¡¨æ‹†åˆ†åˆ°å„ä¸ªçŠ¶æ€æœºä¸­ã€‚åŒæ—¶éœ€è¦å°†è¡Œä¸ºåŠ¨ä½œä»çŠ¶æ€å‡½æ•°ä¸­å‰¥ç¦»å‡ºæ¥ã€‚</p>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 lovely-lily&#39;s blog
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;lovely-lily
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>

	<canvas
	    id="fireworks"
 	   style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 32767"
	></canvas>
	<script src="https://s4.zstatic.net/ajax/libs/animejs/3.2.1/anime.min.js"></script>
	<script src="https://static-argvchs.netlify.app/js/fireworks.min.js"></script>

    <script src="/js/main.js"></script>
    
    




    
</body>
</html>